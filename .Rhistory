dat = readRDS(paste0(pth.data, "pca_all.rds"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, class2_share_qty:=]
dat[, class2_share_value:=]
names(dat)
codes = length(unique(dat$BNF_Code))
sections = unique(dat$BNF_section_name)
"Antidepressant Drugs"
"Antihist, Hyposensit & Allergic Emergen" "Cough Preparations"
plot.month = function()
dat.monthly = dat[BNF_section_name== "Alcohol, Wines & Spirits" , list(net_cost_total = sum(net_cost)), by = period_date]
setkeyv(dat.monthly, "period_date")
ggplot(data = dat.monthly, aes(x = 1:13, y =net_cost_total)) +
geom_point() + geom_line() + expand_limits(y=0) +
theme_bw()
sections
dat[ , list(net_cost_total = sum(net_cost)), by = section][order(-net_cost_total)]
dat[ , list(net_cost_total = sum(net_cost)), by = BNF_seciont_name][order(-net_cost_total)]
dat[ , list(net_cost_total = sum(net_cost)), by = BNF_section_name][order(-net_cost_total)]
dat[, class2_share_value:=(net_cost_class2/net_cost_class)]
dat[, class2_share_value:=(net_cost_class2/net_cost_class2)]
names(dat)
dat.names = c("code","section", "chemical", "drug")
dat = readRDS(paste0(pth.data, "pca_all.rds"))
dat.names = c("code","section", "chemical", "drug")
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_value:=(net_cost_class2/net_cost_class2)]
names(dat)
#install.packages("bit64")
require(bit64)
library(ggplot2)
dat = readRDS(paste0(pth.data, "pca_all.rds"))
dat.names = c("code","section", "chemical", "drug")
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_value:=(net_cost_class2/net_cost_class2)]
names(dat)
codes = length(unique(dat$code))
sections = unique(dat$section)
sections
dat[ , list(net_cost_total = sum(net_cost)), by = section][order(-net_cost_total)]
sections = unique(dat$section)
dat[ , list(net_cost_total = sum(net_cost)), by = section][order(-net_cost_total)]
dat = readRDS(paste0(pth.data, "pca_all.rds"))
dat.names = c("code","section", "chemical", "drug")
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_value:=(net_cost_class2/net_cost_class2)]
names(dat)
names(dat) = c("code","section", "chemical", "drug")
dat[,1:4,with=FALSE]
setnames(dat[,1:4,with=FALSE], c("code","section", "chemical", "drug"))
dat
dat = readRDS(paste0(pth.data, "pca_all.rds"))
setnames(dat[,1:4,with=FALSE], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
names(dat)
codes = length(unique(dat$code))
sections = unique(dat$section)
sections
names(dat)
setnames(dat[,1:4,with=FALSE], c("code","section", "chemical", "drug"))
dat
dat[1:4,with=FALSE]
setnames(dat[1:4,with=FALSE], c("code","section", "chemical", "drug"))
setnames(dat[1:4,,with=FALSE], c("code","section", "chemical", "drug"))
setnames(dat[,1:4,with=FALSE], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
dat[,1:4,with=FALSE]
setnames(dat, names(dat)[1:4], c("code","section", "chemical", "drug"))
dat = readRDS(paste0(pth.data, "pca_all.rds"))
setnames(dat, names(dat)[1:4], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
codes = length(unique(dat$code))
sections = unique(dat$section)
codes
sections
print(sections)
source('~/Projects/prescriptions/pca_analysis.R')
dat.monthly = dat[BNF_section_name== "Cough Preparations" , list(net_cost_total = sum(net_cost)), by = period_date]
dat.monthly = dat[section== "Cough Preparations" , list(net_cost_total = sum(net_cost)), by = period_date]
dat.monthly = dat[section== "Cough Preparations" ,
list(net_cost_total = sum(net_cost)),
by = period_date]
setkeyv(dat.monthly, "period_date")
ggplot(data = dat.monthly, aes(x = 1:13, y =net_cost_total)) +
geom_point() + geom_line() + expand_limits(y=0) +
theme_bw()
print(plot1(dat.monthly))
plot1 = function(plot.data)
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total)) +
geom_point() + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot1(dat.monthly))
plot1 = function(plot.data)
{
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total)) +
geom_point() + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot1(dat.monthly))
plot.multi = function(plot.data)
{
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total, colour = section)) +
geom_point(fill=black) + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
plot.multi(dat.monthly)
plot.month = function(section="Cough Preparations")
{
if (length(section)==1){
dat.monthly = dat[section== "Cough Preparations" ,
list(net_cost_total = sum(net_cost)),
by = period_date]
} else {
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = period_date]
}
setkeyv(dat.monthly, "period_date")
}
plot.month = function(section="Cough Preparations")
{
if (length(section)==1){
dat.monthly = dat[section== "Cough Preparations" ,
list(net_cost_total = sum(net_cost)),
by = period_date]
} else {
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = period_date]
}
setkeyv(dat.monthly, "period_date")
dat.monthly
}
data.monthly = function(section="Cough Preparations")
{
if (length(section)==1){
dat.monthly = dat[section== "Cough Preparations" ,
list(net_cost_total = sum(net_cost)),
by = period_date]
} else {
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = period_date]
}
setkeyv(dat.monthly, "period_date")
dat.monthly
}
rm(list=ls())
library(data.table)
require(stringr)
pth.data = "~/data/prescriptions/"
require(bit64)
library(ggplot2)
dat = readRDS(paste0(pth.data, "pca_all.rds"))
setnames(dat, names(dat)[1:4], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
codes = length(unique(dat$code))
sections = unique(dat$section)
print(sections)
dat[ , list(net_cost_total = sum(net_cost)), by = section][order(-net_cost_total)]
sections.filter = c("Antidepressant Drugs",
"Antihist, Hyposensit & Allergic Emergen",
"Cough Preparations")
data.monthly = function(section="Cough Preparations")
{
if (length(section)==1){
dat.monthly = dat[section== "Cough Preparations" ,
list(net_cost_total = sum(net_cost)),
by = period_date]
} else {
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = period_date]
}
setkeyv(dat.monthly, "period_date")
dat.monthly
}
plot1 = function(plot.data)
{
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total)) +
geom_point() + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot1(data.monthly()))
print(plotmulti(data.monthly(sections.filter)))
print(plot.multi(data.monthly(sections.filter)))
plot.multi = function(plot.data)
{
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total, colour = section)) +
geom_point(fill=black) + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot.multi(data.monthly(sections.filter)))
plot.data
data.monthly(sections.filter)
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = c(section,period_date)]
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = c(section,period_date)]
dat.monthly = dat[section %in% sections.filter ,
list(net_cost_total = sum(net_cost)),
by = c("section","period_date")]
source('~/Projects/prescriptions/pca_analysis.R')
plot.multi = function(plot.data)
{
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total, colour = section)) +
geom_point(aes(fill="black")) + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot.multi(data.monthly(sections.filter)))
plot.multi = function(plot.data)
{
ggplot(data = plot.data, aes(x = 1:13, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot.multi(data.monthly(sections.filter)))
dat[, period_date := as.Date(period_date, format = "%yy-%mmm") ]
dat
?as.Date
dat[, period_date := as.Date(period_date, format = "%YYYY-%mm") ]
dat
sqpply(dat,class)
spply(dat,class)
sapply(dat,class)
periods = data.table(period_date=unique(dat$period_date,period = 0)
periods = data.table(period_date=unique(dat$period_date),period = 0)
print(sections)
periods = data.table(period_date=unique(dat$period_date),period = 0)
periods
a = "~/data/prescriptions/"
require(bit64)
library(ggplot2)
dat = readRDS(paste0(pth.data, "pca_all.rds"))
setnames(dat, names(dat)[1:4], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
dat[, period_date := as.Date(period_date, format = "%YYYY-%mm") ]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
sapply(dat,class)
codes = length(unique(dat$code))
sections = unique(dat$section)
periods = data.table(period_date=unique(dat$period_date),period = 0)
periods
dat = readRDS(paste0(pth.data, "pca_all.rds"))
setnames(dat, names(dat)[1:4], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
#dat[, period_date := as.Date(period_date, format = "%YYYY-%mm") ]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
sapply(dat,class)
codes = length(unique(dat$code))
sections = unique(dat$section)
periods = data.table(period_date=unique(dat$period_date),period = 0)
periods
periods = data.table(period_date=unique(dat$period_date),period = 0,key = "period_date")
periods
source('~/Projects/prescriptions/pca_analysis.R')
plot.multi = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw()
}
print(plot.multi(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(facets = section~)
}
print(plot.multi(data.monthly(sections.filter)))
print(plot.multi(data.monthly(sections.filter)))
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(facets = section~)
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(facets = section~)
}
print(plot.multi.facet(data.monthly(sections.filter)))
source('~/Projects/prescriptions/pca_analysis.R')
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section)
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section,ncol=1)
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section,ncol=1, scales = free_y)
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section,ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
source('~/Projects/prescriptions/pca_analysis.R')
source('~/Projects/prescriptions/pca_analysis.R')
source('~/Projects/prescriptions/pca_analysis.R')
print(plot1(data.monthly()))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x2 = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section,ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
data.monthly(sections.filter)
data.monthly(sections.filter)
plot.data=data.monthly(sections.filter)
ggplot(data = plot.data, aes(x2 = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section,ncol=1, scales = "free_y")
ggplot(data = plot.data, aes(x2 = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0)
ggplot(data = plot.data, aes(x = period_date, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section, ncol=1, scales = "free_y")
periods
source('~/Projects/prescriptions/pca_analysis.R')
data.monthly()
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = x, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section, ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period, y =net_cost_total, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section, ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period, y =net_cost_total/1000, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST") + theme_bw() +
facet_wrap(~section, ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period, y =net_cost_total/1000, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST (000)") + theme_bw() + theme(legend.position="none") +
facet_wrap(~section, ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
plot.multi.facet = function(plot.data)
{
ggplot(data = plot.data, aes(x = period, y =net_cost_total/1000, colour = section)) +
geom_point(fill="black") + geom_line() + expand_limits(y=0) +
xlab("Time") + ylab("NET COST (Â£000)") + theme_bw() + theme(legend.position="none") +
facet_wrap(~section, ncol=1, scales = "free_y")
}
print(plot.multi.facet(data.monthly(sections.filter)))
dat[j= list(net_cost_total = sum(net_cost)), by = section][order(-net_cost_total)]
dat.summary = dat[j = list(net_cost_total = sum(net_cost),
cost_mean = mean(net_cost),
cost_sd = sd(net_cost),
cost_cov = sd(net_cost)/mean(net_cost)),
by = section][order(-net_cost_total)]
dat.summary
dat.summary = dat[j = list(net_cost_total = sum(net_cost),
cost_max = max(net_cost),
cost_min = min(net_cost),
cost_range = max(net_cost) - min(net_cost),
cost_mean = mean(net_cost),
cost_sd = sd(net_cost),
cost_cov = sd(net_cost)/mean(net_cost)),
by = section][order(-net_cost_total)]
dat.summary
dat.summary = dat[j = list(net_cost_total = sum(net_cost),
cost_max = max(net_cost),
cost_min = min(net_cost),
cost_range = max(net_cost) - min(net_cost),
cost_mean = mean(net_cost),
cost_sd = sd(net_cost),
cost_cov = sd(net_cost)/mean(net_cost)),
by = section][order(-net_cost_total)]
dat.summary
dat.summary[, cost_rank := 1:.N]
dat.summary
dat.section = [, list(net_cost = sum(net_cost)), by = c("period")]
dat.section = dat[, list(net_cost = sum(net_cost)), by = c("period")]
dat.section = dat[, list(net_cost = sum(net_cost)), by = c("period")]
dat.section = dat[, list(net_cost = sum(net_cost)), by = c("period_date")]
rm(list=ls())
library(data.table)
require(stringr)
pth.data = "~/data/prescriptions/"
require(bit64)
library(ggplot2)
dat = readRDS(paste0(pth.data, "pca_all.rds"))
setnames(dat, names(dat)[1:4], c("code","section", "chemical", "drug"))
dat[, net_cost_class2 := net_cost_class2/100]
dat[, net_cost := net_cost/100]
#dat[, period_date := as.Date(period_date, format = "%YYYY-%mm") ]
dat[, class2_share_qty:=(quantity_class2/quantity)]
dat[, class2_share_cost:=(net_cost_class2/net_cost_class2)]
names(dat)
sapply(dat,class)
codes = length(unique(dat$code))
sections = unique(dat$section)
periods = data.table(period_date=unique(dat$period_date),period = 1:13,key = "period_date")
dat.section = dat[, list(net_cost = sum(net_cost)), by = c("period_date")]
dat.summary = dat.section[j = list(net_cost_total = sum(net_cost),
cost_max = max(net_cost),
cost_min = min(net_cost),
cost_range = max(net_cost) - min(net_cost),
cost_mean = mean(net_cost),
cost_sd = sd(net_cost),
cost_cov = sd(net_cost)/mean(net_cost)),
by = section][order(-net_cost_total)]
dat.summary[, cost_rank := 1:.N]
dat.section = dat[, list(net_cost = sum(net_cost)), by = c("section", "period_date")]
dat.summary = dat.section[j = list(net_cost_total = sum(net_cost),
cost_max = max(net_cost),
cost_min = min(net_cost),
cost_range = max(net_cost) - min(net_cost),
cost_mean = mean(net_cost),
cost_sd = sd(net_cost),
cost_cov = sd(net_cost)/mean(net_cost)),
by = section][order(-net_cost_total)]
dat.summary[, cost_rank := 1:.N]
print(dat.summary)
print(dat.summary)
dat.section = dat[, list(net_cost = sum(net_cost)/1000), by = c("section", "period_date")]
dat.summary = dat.section[j = list(net_cost_total = sum(net_cost),
cost_max = max(net_cost),
cost_min = min(net_cost),
cost_range = max(net_cost) - min(net_cost),
cost_mean = mean(net_cost),
cost_sd = sd(net_cost),
cost_cov = sd(net_cost)/mean(net_cost)),
by = section][order(-net_cost_total)]
dat.summary[, cost_rank := 1:.N]
print(dat.summary)
ggplot(dat.summary, aes(y = section, x = net_cost_total)) + geom_point()
ggplot(dat.summary, aes(y = order(section, -net_cost_total), x = net_cost_total)) + geom_point()
ggplot(dat.summary, aes(y = reorder(section, -net_cost_total), x = net_cost_total)) + geom_point()
ggplot(dat.summary, aes(y = reorder(section, net_cost_total), x = net_cost_total)) + geom_point()
ggplot(dat.summary[cost_rank<=50], aes(y = reorder(section, net_cost_total), x = net_cost_total)) + geom_point()
ggplot(dat.summary[cost_rank<=30], aes(y = reorder(section, net_cost_total), x = net_cost_total)) + geom_point()
source('~/Projects/prescriptions/pca_analysis.R')
source('~/Projects/prescriptions/pca_analysis.R')
source('~/Projects/prescriptions/pca_analysis.R')
